<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RichBrat$ Customs | Members Only</title>
    
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500&f[]=clash-display@600,700&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDoU-ixQiMmjEofIAK_sQe729PZ86jseDY",
            authDomain: "richbart-customs.firebaseapp.com",
            projectId: "richbart-customs",
            storageBucket: "richbart-customs.firebasestorage.app",
            messagingSenderId: "717900685166",
            appId: "1:717900685166:web:095f2354c75917907c6b7f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.auth = auth; window.db = db;
        window.firebase = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, doc, setDoc, getDoc };
    </script>

    <style>
        /* --- CORE UI --- */
        :root {
            --gold: #D4AF37;
            --black: #0a0a0a;
            --dark-grey: #121212;
            --text-main: 'Satoshi', sans-serif;
            --text-display: 'Clash Display', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--black); color: #fff; font-family: var(--text-main); overflow-x: hidden; }

        .gold-text { color: var(--gold); }

        .btn-luxury {
            background: transparent; border: 1px solid var(--gold); color: var(--gold);
            padding: 12px 30px; font-family: var(--text-display); text-transform: uppercase;
            letter-spacing: 2px; cursor: pointer; transition: 0.3s;
        }
        .btn-luxury:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }

        /* --- NAV & MODALS --- */
        nav { position: fixed; top: 0; width: 100%; padding: 30px 50px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; background: rgba(10,10,10,0.9); }
        .logo { font-family: var(--text-display); font-size: 1.5rem; font-weight: 700; cursor: pointer; }
        .user-panel { display: flex; gap: 20px; align-items: center; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-box { width: 400px; background: var(--dark-grey); padding: 40px; text-align: center; border: 1px solid #333; }
        .form-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #333; padding: 15px 0; color: #fff; margin-bottom: 20px; font-family: var(--text-main); }
        .form-input:focus { outline: none; border-bottom-color: var(--gold); }

        /* --- SECTIONS --- */
        .section { display: none; min-height: 100vh; padding: 120px 50px; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HERO */
        .hero { display: flex; align-items: center; justify-content: center; height: 100vh; background: url('https://images.unsplash.com/photo-1618843479313-40f8afb4b4d8?q=80&w=2070') center/cover; }
        .hero-content { background: rgba(0,0,0,0.8); padding: 50px; border: 1px solid var(--gold); text-align: center; }
        .hero h1 { font-family: var(--text-display); font-size: 4rem; margin-bottom: 20px; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 40px; }
        .dash-card { background: var(--dark-grey); padding: 40px; text-align: center; border: 1px solid #222; cursor: pointer; transition: 0.3s; }
        .dash-card:hover { border-color: var(--gold); transform: translateY(-5px); }

        /* CONTENT LAYOUTS */
        .content-box { max-width: 800px; margin: 0 auto; background: var(--dark-grey); padding: 50px; border: 1px solid #222; }
        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .product-item { background: #000; padding: 15px; text-align: center; border: 1px solid #333; }
        .prod-img { width: 100%; height: 150px; background-size: cover; background-position: center; margin-bottom: 15px; }
    </style>
</head>
<body>

    <nav>
        <div class="logo" onclick="app.navTo('view-landing')">RICHBRAT<span class="gold-text">$</span></div>
        <div class="user-panel" id="nav-actions">
            <span style="cursor:pointer;" onclick="openModal('login')">LOGIN</span>
            <button class="btn-luxury" style="padding: 8px 15px; font-size: 0.8rem;" onclick="openModal('register')">JOIN</button>
        </div>
        <div class="user-panel" id="user-actions" style="display:none;">
            <span id="nav-username" style="cursor:pointer; font-weight:bold;" onclick="app.navTo('view-dashboard')">USER</span>
            <span style="cursor:pointer; color:#666;" onclick="app.logout()">LOGOUT</span>
        </div>
    </nav>

    <div class="modal-overlay" id="auth-modal">
        <div class="modal-box">
            <h2 id="modal-title" style="margin-bottom: 30px; font-family: var(--text-display);">LOGIN</h2>
            <form onsubmit="app.handleAuth(event)">
                <input type="text" id="reg-name" class="form-input" placeholder="FULL NAME" style="display:none;">
                <input type="email" id="email" class="form-input" placeholder="EMAIL" required>
                <input type="password" id="password" class="form-input" placeholder="PASSWORD" required>
                <div id="extra-fields" style="display:none;">
                    <input type="tel" id="reg-phone" class="form-input" placeholder="PHONE NUMBER">
                    <input type="text" id="reg-car" class="form-input" placeholder="YOUR CAR">
                    <input type="text" id="reg-insta" class="form-input" placeholder="INSTAGRAM HANDLE">
                </div>
                <button type="submit" class="btn-luxury" style="width:100%;" id="submit-btn">ENTER</button>
            </form>
            <p style="margin-top:20px; color:#666; cursor:pointer;" onclick="switchMode()">Toggle Login / Register</p>
            <p style="margin-top:10px; color:#666; cursor:pointer;" onclick="closeModal()">Close</p>
        </div>
    </div>

    <div id="view-landing" class="section active">
        <div class="hero">
            <div class="hero-content">
                <p style="color:#888; letter-spacing: 3px;">BESPOKE AUTOMOTIVE ART</p>
                <h1>WELCOME TO THE<br><span class="gold-text">GARAGE</span></h1>
                <button class="btn-luxury" onclick="openModal('register')">BECOME A MEMBER</button>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="section">
        <h2 style="font-family: var(--text-display); font-size: 2.5rem;">WELCOME, <span id="dash-name" class="gold-text">DRIVER</span></h2>
        <p style="color:#666;">Vehicle: <span id="dash-car">--</span></p>

        <div class="dashboard-grid">
            <div class="dash-card" onclick="app.loadStore()">
                <h3 class="gold-text">STORE</h3>
                <p style="color:#888; margin-top:10px;">Purchase Parts & Merch</p>
            </div>
            <div class="dash-card" onclick="app.navTo('view-booking')">
                <h3 class="gold-text">BOOKING</h3>
                <p style="color:#888; margin-top:10px;">Reserve a Garage Slot</p>
            </div>
            <div class="dash-card" onclick="app.navTo('view-consult')">
                <h3 class="gold-text">CONSULT</h3>
                <p style="color:#888; margin-top:10px;">Chat with our Experts</p>
            </div>
        </div>
    </div>

    <div id="view-store" class="section">
        <div class="content-box">
            <h2 class="gold-text" style="font-family: var(--text-display); margin-bottom: 20px;">INVENTORY</h2>
            <div id="loading-store" style="color:#666; text-align:center;">FETCHING INVENTORY...</div>
            <div class="store-grid" id="product-list"></div>
            <button class="btn-luxury" style="margin-top:30px;" onclick="app.navTo('view-dashboard')">← BACK</button>
        </div>
    </div>

    <div id="view-booking" class="section">
        <div class="content-box">
            <h2 class="gold-text" style="font-family: var(--text-display); margin-bottom: 20px;">RESERVATION</h2>
            <form id="bookingForm" onsubmit="app.bookSlot(event)">
                <input type="date" id="b_date" class="form-input" required onchange="app.checkSlots()">
                <select id="b_time" class="form-input" style="background:#121212;" disabled>
                    <option>Select Date First</option>
                </select>
                <input type="text" id="b_name" class="form-input" placeholder="DRIVER NAME" required>
                <input type="tel" id="b_phone" class="form-input" placeholder="PHONE" required>
                <input type="text" id="b_car" class="form-input" placeholder="CAR MODEL" required>
                
                <button type="submit" id="bookBtn" class="btn-luxury" style="width:100%;">CONFIRM SLOT</button>
                <div id="booking-status" style="margin-top:10px; text-align:center;"></div>
            </form>
            <button class="btn-luxury" style="margin-top:30px;" onclick="app.navTo('view-dashboard')">← BACK</button>
        </div>
    </div>

    <div id="view-consult" class="section">
        <div class="content-box">
            <h2 class="gold-text" style="font-family: var(--text-display); margin-bottom: 20px;">PROJECT BRIEF</h2>
            <form onsubmit="app.sendMail(event)">
                <input type="text" id="c_name" class="form-input" placeholder="YOUR NAME" required>
                <input type="text" id="c_car" class="form-input" placeholder="CAR MODEL" required>
                <textarea id="c_message" class="form-input" rows="4" placeholder="DESCRIBE THE BUILD..." required></textarea>
                <button type="submit" class="btn-luxury" style="width:100%;" id="mailBtn">SEND TO EXPERT</button>
                <p id="mailStatus" style="text-align:center; margin-top:10px;"></p>
            </form>
            <button class="btn-luxury" style="margin-top:30px;" onclick="app.navTo('view-dashboard')">← BACK</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // 1. Google Sheets App Script URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPKr6-zQ3fGQITAm5qBpKeCGrnWTHsWMeiw7Hsl9liaNcI4tdLRD6U94jpKCMN6Ru7KQ/exec";
        
        // 2. EmailJS Config
        emailjs.init("9-7GR7Lab7wUNI5sH");

        // --- UI & MODAL CONTROL ---
        let authMode = 'login';
        window.openModal = (mode) => { authMode = mode; updateModalUI(); document.getElementById('auth-modal').style.display = 'flex'; }
        window.closeModal = () => document.getElementById('auth-modal').style.display = 'none';
        window.switchMode = () => { authMode = authMode === 'login' ? 'register' : 'login'; updateModalUI(); }

        function updateModalUI() {
            document.getElementById('modal-title').innerText = authMode === 'register' ? "CREATE ACCOUNT" : "LOGIN";
            document.getElementById('submit-btn').innerText = authMode === 'register' ? "REGISTER" : "ENTER";
            document.getElementById('reg-name').style.display = authMode === 'register' ? 'block' : 'none';
            document.getElementById('extra-fields').style.display = authMode === 'register' ? 'block' : 'none';
        }

        // --- MASTER APP LOGIC ---
        class App {
            constructor() {
                // Firebase Auth Listener
                setTimeout(() => {
                    window.auth.onAuthStateChanged(user => {
                        if (user) {
                            this.loadProfile(user.uid);
                            document.getElementById('nav-actions').style.display = 'none';
                            document.getElementById('user-actions').style.display = 'flex';
                            this.navTo('view-dashboard');
                        } else {
                            document.getElementById('nav-actions').style.display = 'flex';
                            document.getElementById('user-actions').style.display = 'none';
                            this.navTo('view-landing');
                        }
                    });
                }, 1000);
            }

            navTo(id) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }

            // 1. FIREBASE AUTHENTICATION
            async handleAuth(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    if (authMode === 'register') {
                        const cred = await window.firebase.createUserWithEmailAndPassword(window.auth, email, password);
                        await window.firebase.setDoc(window.firebase.doc(window.db, "users", cred.user.uid), {
                            name: document.getElementById('reg-name').value,
                            phone: document.getElementById('reg-phone').value,
                            car: document.getElementById('reg-car').value,
                            insta: document.getElementById('reg-insta').value,
                            email: email
                        });
                    } else {
                        await window.firebase.signInWithEmailAndPassword(window.auth, email, password);
                    }
                    closeModal();
                } catch (error) { alert("Access Denied: " + error.message); }
            }

            async loadProfile(uid) {
                const docSnap = await window.firebase.getDoc(window.firebase.doc(window.db, "users", uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Dashboard Text
                    document.getElementById('dash-name').innerText = data.name.toUpperCase();
                    document.getElementById('nav-username').innerText = data.name.split(' ')[0].toUpperCase();
                    document.getElementById('dash-car').innerText = data.car || "NOT SET";
                    
                    // Auto-fill Consult Form
                    document.getElementById('c_name').value = data.name;
                    document.getElementById('c_car').value = data.car;

                    // Auto-fill Booking Form
                    document.getElementById('b_name').value = data.name;
                    document.getElementById('b_phone').value = data.phone;
                    document.getElementById('b_car').value = data.car;
                }
            }

            logout() { window.firebase.signOut(window.auth); }

            // 2. GOOGLE SHEETS: STORE INVENTORY
            async loadStore() {
                this.navTo('view-store');
                const list = document.getElementById('product-list');
                const loader = document.getElementById('loading-store');
                list.innerHTML = "";
                loader.style.display = 'block';

                try {
                    const res = await fetch(`${SCRIPT_URL}?action=getInventory`);
                    const data = await res.json();
                    loader.style.display = 'none';

                    if(data.length === 0) { list.innerHTML = "<p>OUT OF STOCK</p>"; return; }

                    data.forEach(p => {
                        list.innerHTML += `
                        <div class="product-item">
                            <div class="prod-img" style="background-image:url('${p.image}')"></div>
                            <h3 style="font-family:var(--text-display);">${p.name}</h3>
                            <p style="color:var(--gold); margin: 10px 0;">$${p.price}</p>
                            <button class="btn-luxury" style="padding:10px; font-size:0.8rem;" onclick="window.open('https://wa.me/919999999999?text=Buy ${p.name}')">ORDER</button>
                        </div>`;
                    });
                } catch(e) { loader.innerText = "DATA ERROR - CHECK SCRIPT URL"; }
            }

            // 3. GOOGLE SHEETS: BOOKING SLOTS
            async checkSlots() {
                const date = document.getElementById('b_date').value;
                const sel = document.getElementById('b_time');
                const btn = document.getElementById('bookBtn');
                
                sel.innerHTML = "<option>SCANNING...</option>";
                sel.disabled = true; btn.disabled = true;

                try {
                    const res = await fetch(`${SCRIPT_URL}?action=checkSlots&date=${date}`);
                    const taken = await res.json();
                    const hours = ["10:00","11:00","12:00","13:00","14:00","15:00","16:00"];
                    
                    const avail = hours.filter(h => !taken.includes(h));
                    sel.innerHTML = "";
                    
                    if(avail.length === 0) { sel.innerHTML = "<option>FULL</option>"; }
                    else {
                        avail.forEach(h => sel.innerHTML += `<option value="${h}">${h}</option>`);
                        sel.disabled = false; btn.disabled = false;
                    }
                } catch(e) { sel.innerHTML = "<option>ERROR</option>"; }
            }

            async bookSlot(e) {
                e.preventDefault();
                const btn = document.getElementById('bookBtn');
                const stat = document.getElementById('booking-status');
                btn.innerText = "BOOKING...";
                
                const fd = new FormData();
                fd.append('date', document.getElementById('b_date').value);
                fd.append('time', document.getElementById('b_time').value);
                fd.append('name', document.getElementById('b_name').value);
                fd.append('phone', document.getElementById('b_phone').value);
                fd.append('car', document.getElementById('b_car').value);

                try {
                    await fetch(SCRIPT_URL, {method:'POST', body:fd});
                    stat.innerText = "CONFIRMED!"; stat.style.color = "#d4af37";
                    document.getElementById('bookingForm').reset();
                    setTimeout(() => { this.navTo('view-dashboard'); stat.innerText=""; btn.innerText="CONFIRM SLOT"; }, 2000);
                } catch(e) { stat.innerText = "FAILED"; }
            }

            // 4. EMAILJS: CONSULT
            sendMail(e) {
                e.preventDefault();
                const btn = document.getElementById('mailBtn');
                const status = document.getElementById('mailStatus');
                btn.innerText = "SENDING...";

                const params = {
                    from_name: document.getElementById('c_name').value,
                    car_model: document.getElementById('c_car').value,
                    message: document.getElementById('c_message').value
                };

                emailjs.send("service_ilkre51", "template_hu62u55", params)
                .then(() => { status.innerText = "SENT TO EXPERT!"; status.style.color = "#d4af37"; btn.innerText = "SEND"; })
                .catch(() => { status.innerText = "ERROR!"; status.style.color = "red"; btn.innerText = "RETRY"; });
            }
        }

        const app = new App();
    </script>
</body>
</html>
